<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8">
        <title>Game</title>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/es5-shim/4.5.7/es5-shim.min.js"></script>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/fpsmeter/0.3.1/fpsmeter.min.js"></script>
        <script src="./../dist/penvas.js"></script>
    </head>
    <body>
        <div id="fps"></div>
        <script src="entites/player.js" charset="utf-8"></script>
        <script src="entites/map.js" charset="utf-8"></script>
        <script src="entites/sword.js" charset="utf-8"></script>
        <script src="entites/chest.js" charset="utf-8"></script>
        <script src="entites/monster.js" charset="utf-8"></script>
        <script>
            var meter = new FPSMeter(document.getElementById('fps'));

            class Main extends Scene {
                constructor(app) {
                    super(app, {
                        x: 0, y: 0,
                        width: 320, height: 320,
                        scaleX: 2, scaleY: 2,
                        deadZoneX: app.canvas.width / 2,
                        deadZoneY: app.canvas.height / 2,
                        imageSmoothingEnabled: false
                    });
                }

                create() {
                    this.map = new DungeonMap('map1');
                    this.player = new Player(32, 32);
                    this.sword = new Sword(32, 32);
                    this.chest = new Chest(48, 48);
                    this.monster = new Monster(64, 128);
                    this.particles = new Collection();

                    this.collisions.add(this.player, this.map.getPlatform('platforms'));
                    this.collisions.add(this.monster, this.map.getPlatform('platforms'));
                    this.collisions.add(this.sword, this.chest, (sword, chest) => {
                        if (sword.hitting) {
                            chest.open();
                        }
                    });

                    this.collisions.add(this.sword, this.monster, (sword, monster) => {
                        if (sword.hitting) {
                            monster.hit(sword, this.player.direction);

                            for (let i = 0; i < 50; i++) {
                                this.particles.push(new Particle(monster.x, monster.y, 'fillrect', {
                                    width: 2,
                                    height: 2,
                                    color: 'red',
                                    velocity: 1,
                                    step: 0.05,
                                    rotate: Math.floor(Math.random() * 360)
                                }));
                            }
                        }
                    });

                    this.renderer.add([this.player, this.monster, this.chest], el => el.y);
                    this.renderer.add(this.sword, el => el.y + el.width);

                    events.on('monster-dead', monster => {
                        this.renderer.remove(monster);
                        this.collisions.remove(monster);
                    });

                    this.createUI();
                }

                createUI() {
                    const button = new UIButton('Start', ['btn']);

                    this.uiContainer = new UIContainer(this.parent.container);
                    this.uiContainer.appendChild(button);

                    button.on('click', () => alert('lol'));
                }

                step(dt) {
                    this.collisions.check();

                    if (!this.player.collision) {
                        ticker.every(6, () => this.player.rotating());
                        this.player.step(dt);
                    }

                    let playerPos = { x: this.player.hitbox.x + this.player.hitbox.width / 2, y: this.player.hitbox.y + this.player.hitbox.height / 2 };
                    let monsterPos = { x: this.monster.x + this.monster.width / 2, y: this.monster.y + this.monster.height / 2 }
                    this.path = this.map.findPathBetweenPositions('platforms', monsterPos, playerPos);

                    this.sword.attachTo(this.player);
                    this.sword.step(dt);
                    this.chest.step(dt);

                    ticker.every(5, () => this.monster.follow(this.path[1]));
                    ticker.every(10, () => this.monster.rotating());
                    this.monster.step(dt);

                    this.viewport.follow(this.player, this.world);

                    this.particles.step(dt);
                }

                render() {
                    meter.tickStart();

                    this.parent.clearLayer();
                    this.world.clearLayer();

                    this.map.render(this.world, { minZ: 1, maxZ: 2, view: this.viewport });
                    this.renderer.render();
                    this.map.render(this.world, { layer: 'top', view: this.viewport });
                    //this.world.debug([this.sword, this.monster]);

                    /*this.path.forEach(tile => {
                        this.world.drawRect(tile.x, tile.y, 16, 16);
                    });*/

                    this.particles.render(this.world);

                    super.render();
                    meter.tick();
                }
            }

            var app = new Application({
                width: 500,
                height: 500,

                create: function() {
                    loader.add('images/tileset.png', 'tileset');
                    loader.add('maps/map1.json', 'map1', 'json');
                },

                ready: function() {
                    this.addLayer('home', Main);
                    this.changeLayer('home');
                }
             });
        </script>
    </body>
</html>
